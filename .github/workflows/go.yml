name: CI/CD

on:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:
    branches: [main]

permissions:
  contents: read
  id-token: write # 用于 OIDC 签名

jobs:
  test:
    permissions:
      contents: read

  test-integration:
    permissions:
      contents: read

  release:
    permissions:
      contents: write  # release 需要写入权限
      id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ["1.25"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build
        run: go build ./...

      - name: Test (skip slow pubsub tests)
        run: go test -timeout 30s -short ./... -skip "TestRemoveSubscriber|TestUnsubscribe|TestSubscribe"

      - name: Upload coverage
        if: matrix.go-version == '1.25'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          fail_ci_if_error: false

  test-integration:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Run integration tests
        run: go test -timeout 60s ./cmd/integration/... -skip "_Test"

  release:
    runs-on: ubuntu-latest
    needs: [test, test-integration]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Create version variable
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Build binaries
        run: |
          PLATFORMS=("linux-amd64 linux arm64" "linux-arm64 linux arm" "darwin-amd64 darwin amd64" "darwin-arm64 darwin arm64" "windows-amd64 windows amd64")
          for platform in "${PLATFORMS[@]}"; do
            IFS=' ' read -r osarch os arch <<< "$platform"
            ext=""
            if [ "$os" = "windows" ]; then ext=".exe"; fi
            echo "Building for $os-$arch..."
            # Main binary
            CGO_ENABLED=0 GOOS=$os GOARCH=$arch go build -o boltDB-${VERSION}-${osarch}${ext} -ldflags "-s -w -X main.version=${VERSION}" ./cmd/boltDB/
            # Sentinel binary
            CGO_ENABLED=0 GOOS=$os GOARCH=$arch go build -o boltDB-sentinel-${VERSION}-${osarch}${ext} -ldflags "-s -w" ./cmd/sentinel/
          done

      - name: Calculate checksums
        run: |
          shasum -a 256 boltDB-*-${VERSION}-* > boltDB-${VERSION}-checksums.txt
          cat boltDB-${VERSION}-checksums.txt

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            boltDB-*-${VERSION}-linux-amd64
            boltDB-*-${VERSION}-linux-arm64
            boltDB-*-${VERSION}-darwin-amd64
            boltDB-*-${VERSION}-darwin-arm64
            boltDB-*-${VERSION}-windows-amd64.exe
            boltDB-sentinel-*-${VERSION}-linux-amd64
            boltDB-sentinel-*-${VERSION}-linux-arm64
            boltDB-sentinel-*-${VERSION}-darwin-amd64
            boltDB-sentinel-*-${VERSION}-darwin-arm64
            boltDB-sentinel-*-${VERSION}-windows-amd64.exe
            boltDB-${VERSION}-checksums.txt
          generate_release_notes: false  # 手动提供 release 说明
          name: Release ${{ env.VERSION }}
          body: |
            # BoltDB ${{ env.VERSION }}

            ## 简介 | Introduction

            BoltDB is a high-performance, disk-persistent key-value store compatible with the Redis protocol. It overcomes Redis's memory limitations by leveraging **BadgerDB** for storage, supporting up to **100TB** of data on disk while maintaining full Redis protocol compatibility.

            BoltDB 是一个高性能、磁盘持久化的键值存储数据库，完全兼容 Redis 协议。它使用 **BadgerDB** 作为存储引擎，克服了 Redis 的内存限制，支持在磁盘上存储高达 **100TB** 的数据，同时保持完整的 Redis 协议兼容性。

            ---

            ## 特性 | Features

            ### 数据类型 | Data Types
            - **String** - 字符串操作 (SET, GET, INCR, etc.)
            - **List** - 双向链表 (LPUSH, RPOP, LRANGE, etc.)
            - **Hash** - 哈希表 (HSET, HGET, HALL, etc.)
            - **Set** - 无序集合 (SADD, SMEMBERS, SINTER, etc.)
            - **Sorted Set** - 有序集合 (ZADD, ZRANGE, ZSCORE, etc.)

            ### 核心功能 | Core Features
            | 功能 | Feature | 描述 | Description |
            |------|---------|------|-------------|
            | 持久化 | Persistence | 数据存储在磁盘 | Data stored on disk |
            | 高可用 | High Availability | Sentinel 哨兵模式 | Sentinel HA mode |
            | 集群 | Clustering | Redis Cluster 支持 | Redis Cluster support |
            | 事务 | Transactions | MULTI/EXEC 支持 | MULTI/EXEC support |
            | 过期 | Expiration | TTL 键过期机制 | TTL key expiration |
            | 备份 | Backup | 在线备份支持 | Online backup support |

            ### 性能 | Performance
            - **写入性能**: Up to 100,000 ops/sec (取决于硬件)
            - **存储容量**: Up to 100TB (受磁盘空间限制)
            - **内存占用**: Minimal (仅索引常驻内存)
            - **读写延迟**: < 1ms (SSD 推荐)

            ---

            ## 安装 | Installation

            ### Linux/macOS

            ```bash
            # 方法 1: 直接下载二进制文件
            curl -L https://github.com/lbp0200/BoltDB/releases/download/v${{ env.VERSION }}/boltDB-${{ env.VERSION }}-$(uname -s | tr '[:upper:]' '[:lower:]')-$(uname -m).tar.gz -o boltDB.tar.gz
            tar -xzf boltDB.tar.gz
            cd boltDB-${{ env.VERSION }}-*/
            ./boltDB --dir=/path/to/data --addr=:6379

            # 方法 2: 使用 Docker
            docker run -d -p 6379:6379 -v /path/to/data:/data lbp0200/boltDB:${{ env.VERSION }}
            ```

            ### Windows

            ```powershell
            # 下载并解压
            Invoke-WebRequest -Uri https://github.com/lbp0200/BoltDB/releases/download/v${{ env.VERSION }}/boltDB-${{ env.VERSION }}-windows-amd64.zip -OutFile boltDB.zip
            Expand-Archive -Path boltDB.zip -DestinationPath boltDB
            cd boltDB
            .\boltDB.exe --dir=C:\path\to\data --addr=:6379
            ```

            ### 从源码编译 | Build from Source

            ```bash
            git clone https://github.com/lbp0200/BoltDB.git
            cd BoltDB
            go build -o boltDB ./cmd/boltDB/
            go build -o boltDB-sentinel ./cmd/sentinel/
            ```

            ---

            ## 使用示例 | Usage Examples

            ### 连接 | Connection

            ```bash
            # 使用 redis-cli 连接
            redis-cli -p 6379

            # 或使用 BoltDB CLI
            ./boltDB-cli
            ```

            ### 基本操作 | Basic Operations

            ```redis
            # String 操作
            SET mykey "Hello World"
            GET mykey
            INCR counter
            DEL mykey

            # List 操作
            LPUSH mylist "item1"
            RPUSH mylist "item2"
            LRANGE mylist 0 -1
            LPOP mylist

            # Hash 操作
            HSET user:1 name "Alice" age 25
            HGET user:1 name
            HGETALL user:1

            # Set 操作
            SADD myset "member1"
            SMEMBERS myset
            SINTER myset1 myset2

            # Sorted Set 操作
            ZADD leaderboard 100 "Alice" 90 "Bob" 80 "Charlie"
            ZRANGE leaderboard 0 -1 WITHSCORES
            ZREVRANGEBYSCORE leaderboard +inf -inf
            ```

            ---

            ## 配置文件 | Configuration

            ### 命令行参数 | Command Line Options

            | 参数 | 默认值 | 描述 |
            |------|--------|------|
            | `--dir` | `./data` | 数据存储目录 |
            | `--addr` | `:6379` | 监听地址 |
            | `--log-level` | `warning` | 日志级别 (debug/info/warning/error) |

            ### 环境变量 | Environment Variables

            | 变量 | 描述 |
            |------|------|
            | `BOLTDB_DIR` | 数据存储目录 |
            | `BOLTDB_ADDR` | 监听地址 |
            | `BOLTDB_LOG_LEVEL` | 日志级别 |

            ---

            ## 高可用部署 | High Availability Deployment

            ### Sentinel 架构 | Sentinel Architecture

            ```
            +------------------+
            |    Application   |
            +--------+---------+
                     |
            +--------+---------+
            |    Sentinel 1    | (可选)
            +--------+---------+
                     |
            +--------+---------+
            |   Master Node    |
            +--------+---------+
                     |
            +--------+---------+
            |   Slave Node     | (可选)
            +------------------+
            ```

            ### 启动 Sentinel

            ```bash
            # 启动 Sentinel
            ./boltDB-sentinel --dir=/path/to/sentinel --addr=:26379

            # 监控主节点
            SENTINEL monitor mymaster 127.0.0.1 6379 2
            SENTINEL down-after-milliseconds mymaster 30000
            SENTINEL failover-timeout mymaster 180000
            ```

            ---

            ## 架构说明 | Architecture

            ```
            ┌─────────────────────────────────────────────────┐
            │                   BoltDB                        │
            ├─────────────────────────────────────────────────┤
            │  ┌─────────────┐  ┌─────────────────────────┐    │
            │  │ Redis Protocol │  │ Cluster Management   │    │
            │  │    Handler    │  │ (16384 Slots)         │    │
            │  └──────┬──────┘  └───────────┬─────────────┘    │
            │         │                       │                   │
            │  ┌──────┴──────┐  ┌───────────┴─────────────┐    │
            │  │ Command Router │  │ Replication/Backup   │    │
            │  └──────┬──────┘  └───────────┬─────────────┘    │
            │         │                       │                   │
            │  ┌──────┴─────────────────────┴──────────────┐   │
            │  │         BadgerDB Storage Engine             │   │
            │  │  ┌─────────┐ ┌─────────┐ ┌─────────────┐   │   │
            │  │  │  WAL    │ │ LSM Tree │ │ Value Log  │   │   │
            │  │  └─────────┘ └─────────┘ └─────────────┘   │   │
            │  └────────────────────────────────────────────┘   │
            └─────────────────────────────────────────────────┘
            ```

            ### 技术栈 | Tech Stack

            - **存储引擎**: [BadgerDB v4](https://github.com/dgraph-io/badger) - LSM-tree based KV store
            - **协议兼容**: Redis RESP2/RESP3 protocol
            - **集群协议**: Redis Cluster (CRC16 hashing, 16384 slots)
            - **复制协议**: Redis Replication (PSYNC, backlog)
            - **日志系统**: [zerolog](https://github.com/rs/zerolog)
            - **构建工具**: Go 1.25+

            ---

            ## 平台支持 | Platform Support

            | 平台 | 架构 | 状态 | Status |
            |------|------|------|--------|
            | Linux | amd64 | ✅ 支持 | Supported |
            | Linux | arm64 | ✅ 支持 | Supported |
            | macOS | amd64 | ✅ 支持 | Supported |
            | macOS | arm64 | ✅ 支持 | Supported |
            | Windows | amd64 | ✅ 支持 | Supported |

            ---

            ## 性能测试 | Benchmarks

            ```bash
            # 使用 redis-benchmark 测试
            redis-benchmark -h localhost -p 6379 -t set,get,incr,lpush,hset,zadd -c 50 -n 100000

            # 预期结果 (SSD, 8核CPU)
            # SET: ~80,000 ops/sec
            # GET: ~90,000 ops/sec
            # INCR: ~75,000 ops/sec
            ```

            ---

            ## 贡献 | Contributing

            Issues 和 Pull Requests 欢迎！

            ```bash
            # 1. Fork 本项目
            # 2. 创建特性分支 (git checkout -b feature/amazing-feature)
            # 3. 提交更改 (git commit -m 'Add amazing feature')
            # 4. 推送到分支 (git push origin feature/amazing-feature)
            # 5. 创建 Pull Request
            ```

            ---

            ## 许可证 | License

            MIT License - 详见 [LICENSE](https://github.com/lbp0200/BoltDB/blob/main/LICENSE)

            ---

            ## 联系方式 | Contact

            - GitHub: [https://github.com/lbp0200/BoltDB](https://github.com/lbp0200/BoltDB)
            - Issues: [https://github.com/lbp0200/BoltDB/issues](https://github.com/lbp0200/BoltDB/issues)

            ---

            **感谢使用 BoltDB!** | **Thanks for using BoltDB!**
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-scan:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Run Gosec
        uses: securego/gosec@master
        with:
          args: ./...

  lint:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: false

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.8.0
          args: --timeout 5m
